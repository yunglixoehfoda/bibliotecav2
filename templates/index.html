{% extends "base.html" %}
{% block content %}

<h1>Biblioteca Online</h1>

<form method="get" class="busca-form">
    <input type="text" name="q" placeholder="Buscar por título ou autor" value="{{ request.args.get('q', '') }}">

    <select name="categoria">
        <option value="">Todas categorias</option>
        {% for c in categorias %}
            <option value="{{ c.id }}" {% if request.args.get('categoria') == c.id|string %}selected{% endif %}>
                {{ c.nome }}
            </option>
        {% endfor %}
    </select>

    <select name="genero">
        <option value="">Todos gêneros</option>
        {% for g in generos %}
            <option value="{{ g.id }}" {% if request.args.get('genero') == g.id|string %}selected{% endif %}>
                {{ g.nome }}
            </option>
        {% endfor %}
    </select>

    <button class="btn btn-primary">Buscar</button>
</form>

{% if livros and livros|length > 0 %}
<div class="tabela-livros" id="cards">

    <div class="linha header">
        <span>Título</span>
        <span>Autor</span>
        <span>Categoria</span>
        <span>Gênero</span>
        <span>Idioma</span>
        <span>Status</span>
    </div>

    {% for l in livros %}
    <div class="linha">
        <span data-label="Título">{{ l.titulo }}</span>
        <span data-label="Autor">{{ l.autor }}</span>
        <span data-label="Categoria">{{ l.categoria }}</span>
        <span data-label="Gênero">{{ l.genero }}</span>
        <span data-label="Idioma">{{ l.idioma }}</span>

        {% if l.disponivel %}
    <span class="status disponivel">Disponível</span>
{% else %}
    <div class="status emprestado">
        <span>Emprestado</span>

        {# prazo: se vier do empréstimo usa ele, senão usa o padrão #}
        {% set prazo = l.prazo_total if l.prazo_total and l.prazo_total > 0 else prazo_padrao %}
        {% set dias = l.dias_emprestimo %}
        {% set percent = (dias / prazo * 100) if dias <= prazo else 100 %}

        <div class="prazo-bar">
            <div
                class="prazo-fill
                {% if dias > prazo %}estourado
                {% elif dias > prazo * 0.7 %}alerta
                {% else %}ok{% endif %}"
                style="width: {{ percent }}%">
            </div>
        </div>

        <small>{{ dias }} / {{ prazo }} dias</small>
    </div>
{% endif %}


    </div>
    {% endfor %}

</div>

{% else %}
<div class="skeleton-list">
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>

    <p class="empty-text">
        Nenhum livro encontrado.
    </p>
</div>
{% endif %}


{% endblock %}
